<?php/*********************************************** Copyright : (C) 2021 - Cloverfield Mail: chilm@planet.nl Change date : 06 - 10 - 2021 **********************************************/  session_start();    include 'includes/globals.php';    isset($_REQUEST['action'])     ? $action = mysqli_real_escape_string($conn, $_REQUEST['action'])         : $action ='';  isset($_REQUEST['product_id']) ? $product_id = mysqli_real_escape_string($conn, $_REQUEST['product_id']) : $product_id ='';  isset($_REQUEST['order_idx'])  ? $order_idx = mysqli_real_escape_string($conn, $_REQUEST['order_idx'])   : $order_idx ='';    if (!empty($action))   {    switch ($action)     {      // Basket calculate the shipping costs.      case 'calc_shipping':          // First safe and easy, no hassle. Action in basket.php        mysqli_query ($conn, "UPDATE clo_orders_a SET                                ship_name = '',                                ship_price = '0.00'                              WHERE session_id = '".session_id()."'                              ");          $query = mysqli_query($conn, "SELECT ship_name_".$_SESSION['language'].", ship_price                                       FROM clo_shipping                                       WHERE ship_name_".$_SESSION['language']." = '".mysqli_real_escape_string($conn, $_POST['ship_name'])."'                                      ");                $row    = mysqli_fetch_array($query);          // Save the new values.        mysqli_query ($conn, "UPDATE clo_orders_a SET                              ship_name = '".$row['ship_name_'.$_SESSION['language'].'']."',                              ship_price = '".$row['ship_price']."'                              WHERE session_id = '".session_id()."'                              LIMIT 1                              ");          echo '<script language="JavaScript">location.href="basket.php"</script>';        break;  /* ========================================================== LINE ============================================================ */      // Basket select the payment method with eventual costs.      case 'calc_payment':        // First safe and easy, no hassle. Action in basket.php        mysqli_query ($conn, "UPDATE clo_orders_a SET                              pay_name = '',                              pay_price = '0.00'                              WHERE session_id = '".session_id()."'                              ");        $query = mysqli_query($conn, "SELECT pay_name_".$_SESSION['language'].", pay_price                                       FROM clo_payments                                       WHERE pay_name_".$_SESSION['language']." = '".mysqli_real_escape_string($conn, $_POST['pay_name'])."'                                      ");          $row = mysqli_fetch_array($query);        // Save the new values.        mysqli_query ($conn, "UPDATE clo_orders_a SET                              pay_name = '".$row['pay_name_'.$_SESSION['language'].'']."',                              pay_price = '".$row['pay_price']."'                              WHERE session_id = '".session_id()."'                              LIMIT 1                              ");        echo '<script language="JavaScript">location.href="basket.php"</script>';      break;/* ========================================================== LINE ============================================================ */      // Basket when selected to insure the order for shipping.      case 'calc_insurance':        // First safe and easy, no hassle. Action in basket.php        mysqli_query ($conn, "UPDATE clo_orders_a                               SET fee_insurance = ''                               WHERE session_id = '".session_id()."'                              ");        // Save the new values.        mysqli_query ($conn, "UPDATE clo_orders_a                               SET fee_insurance = '".mysqli_real_escape_string($conn, $_POST['fee_insurance'])."'                               WHERE session_id = '".session_id()."'                               LIMIT 1                              ");        echo '<script language="JavaScript">location.href="basket.php"</script>';      break;/* ========================================================== LINE ============================================================ */      case 'product_update':              // Check stock and message when not sufficient.        $query = mysqli_query($conn, "SELECT stock, meter                                       FROM clo_products                                       WHERE idx = '".$product_id."'                                      ");        $evo = mysqli_fetch_array($query);        if($_POST['quantity'] > $evo['stock'])        {          echo '<script language="javascript">                <!-- begin                alert("Stock is only '.$evo['stock'].' pieces!")                // end -->              </script>                <script language="JavaScript">location.href="javascript:history.go(-1)"</script>';            exit;        }          $price    = mysqli_real_escape_string($conn, $_POST['price']) * mysqli_real_escape_string($conn, $_POST['unit_value']);        $quantity = mysqli_real_escape_string($conn, str_replace(',','.',$_POST['quantity']));          // Assign meter material or not.        $evo['meter'] == 0 ? $meter_material = 0 : $meter_material = 1;        $millimeter = mysqli_real_escape_string($conn, $_POST['millimeter']);        // No hassle delete the eventual old product.        mysqli_query ($conn, "DELETE FROM clo_orders_a                              WHERE session_id = '".session_id()."'                              AND item_id = '".$product_id."'                              ") ;        if ($meter_material == 0)        {          mysqli_query ($conn, "INSERT IGNORE INTO clo_orders_a SET                                  session_id     = '".session_id()."',                                  item_id        = '".$product_id."',                                  price          = '".$price."',                                  quantity       = '".$quantity."',                                  millimeter     = '0',                                  price_cuts     = '0',                                  price_total    = '".$quantity * $price."',                                  created        = CURDATE()                                  ") or die(mysqli_error($conn));          if($_POST['option_box'] != '')          {            $idx = mysqli_insert_id($conn);              // Optie waardes nu toevoegen want session_id nu inserted, MOET hier staan VOOR al het volgende.            foreach ($_POST['option_box'] as $key => $value)            {              $string = mysqli_real_escape_string($conn, $_POST['option_box'][$key]);              $options_string = explode('#',$string);                // Er is een optiekeuze gemaakt.              if($string != 'not')              {                mysqli_query ($conn, "UPDATE clo_orders_a                                      SET product_option = CONCAT(product_option, '".$string.";')                                      WHERE item_id      = '".$product_id."'                                      AND session_id     = '".session_id()."'                                      AND idx            = '".$idx."'                                      ");                  $what   = $options_string[1];                $number = $options_string[2];                  // Wil geen - of + accepteren als variabele naam.                $what == '-' ? $price = $price - $number : $price = $price + $number;                // Now add optionprice to price_total.                mysqli_query ($conn, "UPDATE clo_orders_a                                      SET price_total = '".$price."'                                      WHERE item_id   = '".$product_id."'                                      AND session_id  = '".session_id()."'                                      AND idx         = '".$idx."'                                      ");              }            }          }        }        else if ($meter_material == 1) // Product opslaan WEL metermateriaal.        {          // Totale lengte uitrekenen.          $subtotal_mm = mysqli_real_escape_string($conn, $_POST['quantity']) * $millimeter;          // Totaalprijs voor deze lengte uitrekenen.          $price_total = $subtotal_mm / 1000 * $price;          // Totaalprijs zaagsnedes.          $price_cuts = $quantity * $config['fee_cutting'];          // Uitrekenen prijs lengtes met zaagsnedes.          $price_final = $price_cuts + $price_total;          mysqli_query ($conn, "INSERT IGNORE INTO clo_orders_a SET                                  session_id     = '".session_id()."',                                  item_id        = '".$product_id."',                                  price          = '".$price_final."',                                  quantity       = '".$quantity."',                                  millimeter     = '".$millimeter."',                                  price_cuts     = '".$price_cuts."',                                  price_total    = '".$price_total."',                                  created        = CURDATE()                                  ");        }        echo '<script language="JavaScript">location.href="products-single.php?id='.$product_id.'#pop_cart"</script>';      break;/* ========================================================== LINE ============================================================ */      case 'product_adjust':        $quantity = mysqli_real_escape_string($conn, str_replace(',','.',$_POST['quantity']));        // Productprijs ophalen i.v.m. uitrekenen nieuwe prijs.        $price = mysqli_query($conn, "SELECT price FROM clo_orders_a WHERE idx = '".$order_idx."'");        // Product data eerst verwijderen.        mysqli_query ($conn, "UPDATE clo_orders_a SET                               quantity    = '',                              price_total = ''                              WHERE session_id  = '".session_id()."'                              AND idx           = '".$order_idx."'                              ");        $price_total = $quantity * $price;        mysqli_query ($conn, "UPDATE clo_orders_a                              SET quantity = '".$quantity."',                                 price_total = '".$price_total."'                              WHERE idx = '".$order_idx."'                              AND session_id = '".session_id()."'                              ");        echo '<script language="JavaScript">location.href="basket.php"</script>';      break;  /* ========================================================== LINE ============================================================ */      case 'product_delete':        // Product verwijderen.        mysqli_query ($conn, "DELETE FROM clo_orders_a                              WHERE session_id = '".session_id()."'                              AND idx = '".$order_idx."'                              ");        if (empty($_GET['page']))        {          echo '<script language="JavaScript">location.href="products-single.php?id='.$product_id.'"</script>';        }        elseif ($_GET['page'] == "basket")        {          echo '<script language="JavaScript">location.href="basket.php"</script>';        }        else        {          echo '<script language="JavaScript">location.href="index.php"</script>';        }      break;/* ========================================================== LINE ============================================================ */      case 'order_final':        // To prevent empty form when redirecting if payment and/or shipping is empty.        $_SESSION['tmp_voucher']           = $_POST['voucher'];        $_SESSION['tmp_surname']           = $_POST['surname'];        $_SESSION['tmp_invoice_street']    = $_POST['invoice_street'];        $_SESSION['tmp_invoice_street_nr'] = $_POST['invoice_street_nr'];        $_SESSION['tmp_invoice_zip']       = $_POST['invoice_zip'];        $_SESSION['tmp_invoice_city']      = $_POST['invoice_city'];        $_SESSION['tmp_invoice_country']   = $_POST['invoice_country'];        $_SESSION['tmp_phone']             = $_POST['phone'];        $_SESSION['tmp_email']             = $_POST['email'];        $_SESSION['tmp_order_remarks']     = $_POST['order_remarks'];        // Check if payment and/or shipping is chosen.        $pay_alert  = $LANG['CHOOSE_PAYMENT'];        $ship_alert = $LANG['CHOOSE_DELIVERY'];        if(empty($_POST['pay_name']))        {          echo "<script language='javascript'>alert('$pay_alert')</script>                <script language='JavaScript'>location.href='basket.php'</script>";            exit;        }        if(empty($_POST['ship_name']))        {          echo "<script language='javascript'>alert('$ship_alert')</script>                <script language='JavaScript'>location.href='basket.php'</script>";            exit;        }        // For redirect language url straks onderin omdat ik de sessies daar vernietig.        $language = $_SESSION['language'];        $voucher_yes = '';        // Alle financiele posts verwerken.        if(!empty($_POST['voucher']))        {            $query = mysqli_query($conn, "SELECT * FROM clo_vouchers                                         WHERE coupon_code = '".mysqli_real_escape_string($conn, $_POST['voucher'])."'                                         AND active = '1'                                        ");          $voucher = mysqli_fetch_array($query);          $voucher_yes = 1;        }        // Leave this here and do not touch or place somewhere else.        $discount   = mysqli_real_escape_string($conn, $_POST['discount']);        $total      = mysqli_real_escape_string($conn, $_POST['total']);        $grandtotal = mysqli_real_escape_string($conn, str_replace(',','.',$_POST['grandtotal']));          if(mysqli_real_escape_string($conn, $_POST['invoice_country']) !== 'Nederland')        {          $tax = '0.00';        }        else        {          $tax = mysqli_real_escape_string($conn, $_POST['tax']);        }        $voucher_remarks = '';        // Er is blijkbaar een kortingscode, goed lezen dit.        if($voucher_yes == 1)        {          if($voucher['coupon_type'] == 'pct')          {            $minus           = ($total / 100) * $voucher['coupon_discount'];            $voucher_euro    = $minus;            $total           = $total - $minus;            $grandtotal      = $grandtotal - $minus;            $voucher_remarks = 'Vouchercode redeemed with Nr: <b>'.$_POST['voucher'].'</b><br>Profit is <b>'.$voucher['coupon_discount'].'%</b> from total.<br><br>';              if($config['tax_included'] == 1)            {              $amo = $config['tax_percent'];              $tax = $total / ($amo + 100) * $amo;            }            else if ($config['tax_included'] == 0)            {              $amo = $config['tax_percent'];              $tax = $total / 100 * $amo ;            }            }          else if($voucher['coupon_type'] == 'abs')          {            $total           = $total - $voucher['coupon_discount'];            $grandtotal      = $grandtotal - $voucher['coupon_discount'];            $voucher_euro    = number_format($voucher['coupon_discount'], 2, ",", ".");            $voucher_remarks = 'Vouchercode redeemed with Nr: <b>'.$_POST['voucher'].'</b><br>Profit is <b>&euro; '.$voucher['coupon_discount'].',=</b> on the total amount.<br><br>';              if($config['tax_included'] == 1)            {              $amo = $config['tax_percent'];              $tax = $total / ($amo + 100) * $amo;            }            else if ($config['tax_included'] == 0)            {              $amo = $config['tax_percent'];              $tax = $total / 100 * $amo ;            }          }          else          {            $total 				   = $total;            $grandtotal 	   = $grandtotal;            $tax 			   	   = $tax;            $voucher_euro    = 0;            $voucher_remarks = '';          }        } // Einde kortingscode.        $tax_text   = mysqli_real_escape_string($conn, strip_tags($_POST['tax_text']));        // Moet het in het buitenland afgeleverd worden en wat zijn dan de kosten.        if (mysqli_real_escape_string($conn, $_POST['invoice_country']) !== 'Nederland')        {          $pre_total   = mysqli_real_escape_string($conn, $_POST['total']);          $fee_foreign = $config['fee_foreign_delivery'];          $total       = $pre_total + $fee_foreign;          $grandtotal  = $grandtotal + $fee_foreign;        }        else        {          $fee_foreign = '0.00';          $grandtotal  = $grandtotal;        }        // Zoek uit of de pay_config soms "ideal" of "mollie" is om dan onderin naar MultiSafePay of Mollie te redirecten.        $query = mysqli_query($conn, "SELECT pay_config                                       FROM clo_payments                                       WHERE pay_name_".$_SESSION['language']." = '".mysqli_real_escape_string($conn, $_POST['pay_name'])."'                                      ");        $ideal = mysqli_fetch_array($query);        $msp   = $ideal['pay_config'];        // Wordt er een extra verzekeringsbedrag gerekend?.        $_POST['fee_insurance'] !== '0.00' ? $insurance = $config['fee_insurance'] : $insurance = '0.00';        // Controleren of de klant al bestaat.        $query = mysqli_query($conn, "SELECT *                                       FROM clo_customers                                       WHERE email = '".mysqli_real_escape_string($conn, $_POST['email'])."'                                      ");                $customer = mysqli_fetch_array($query);          // Wil de klant zich meteen registreren:        if (!empty($_POST['password']))         {          $password   = md5($_POST['password']);            if ($super['allow_consumer'] == 1)           {            $registered = 1;            $active     = 1;          }           else           {            $registered = 0;            $active     = 0;          }        }         else         {          $password   = '';          $registered = 0;          $active     = 1;        }          // Als de klant NIET bestaat gaan we hem aanmaken.        if ((!mysqli_num_rows($query)) > 0)        {          mysqli_query ($conn, "INSERT IGNORE INTO clo_customers SET                                email             = '".strtolower(mysqli_real_escape_string($conn, $_POST['email']))."',                                username          = '".strtolower(mysqli_real_escape_string($conn, $_POST['email']))."',                                `password`        = '".$password."',                                registered        = '".$registered."',                                saluation         = '".mysqli_real_escape_string($conn, $_POST['saluation'])."',                                surname           = '".ucfirst(mysqli_real_escape_string($conn, $_POST['surname']))."',                                invoice_street    = '".ucfirst(mysqli_real_escape_string($conn, $_POST['invoice_street']))."',                                invoice_street_nr = '".mysqli_real_escape_string($conn, $_POST['invoice_street_nr'])."',                                invoice_zip       = '".mysqli_real_escape_string($conn, $_POST['invoice_zip'])."',                                invoice_city      = '".ucfirst(mysqli_real_escape_string($conn, $_POST['invoice_city']))."',                                invoice_country   = '".mysqli_real_escape_string($conn, $_POST['invoice_country'])."',                                deliver_street    = '".ucfirst(mysqli_real_escape_string($conn, $_POST['invoice_street']))."',                                deliver_street_nr = '".mysqli_real_escape_string($conn, $_POST['invoice_street_nr'])."',                                deliver_zip       = '".mysqli_real_escape_string($conn, $_POST['invoice_zip'])."',                                deliver_city      = '".ucfirst(mysqli_real_escape_string($conn, $_POST['invoice_city']))."',                                deliver_country   = '".mysqli_real_escape_string($conn, $_POST['invoice_country'])."',                                phone             = '".mysqli_real_escape_string($conn, $_POST['phone'])."',                                active            = '".$active."',                                created           = CURDATE()                                ");          } // EOF klant aanmaken.        // Als de klant WEL bestaat gaan we hem updaten vanwege adresveranderingen etc..        if (mysqli_num_rows($query) > 0)        {          mysqli_query ($conn, "UPDATE clo_customers SET                                  email             = '".strtolower(mysqli_real_escape_string($conn, $_POST['email']))."',                                  username          = '".strtolower(mysqli_real_escape_string($conn, $_POST['email']))."',                                  `password`        = '".$password."',                                  registered        = '".$registered."',                                  saluation         = '".mysqli_real_escape_string($conn, $_POST['saluation'])."',                                  surname           = '".ucfirst(mysqli_real_escape_string($conn, $_POST['surname']))."',                                  invoice_street    = '".ucfirst(mysqli_real_escape_string($conn, $_POST['invoice_street']))."',                                  invoice_street_nr = '".mysqli_real_escape_string($conn, $_POST['invoice_street_nr'])."',                                  invoice_zip       = '".mysqli_real_escape_string($conn, $_POST['invoice_zip'])."',                                  invoice_city      = '".ucfirst(mysqli_real_escape_string($conn, $_POST['invoice_city']))."',                                  invoice_country   = '".mysqli_real_escape_string($conn, $_POST['invoice_country'])."',                                  deliver_street    = '".ucfirst(mysqli_real_escape_string($conn, $_POST['invoice_street']))."',                                  deliver_street_nr = '".mysqli_real_escape_string($conn, $_POST['invoice_street_nr'])."',                                  deliver_zip       = '".mysqli_real_escape_string($conn, $_POST['invoice_zip'])."',                                  deliver_city      = '".ucfirst(mysqli_real_escape_string($conn, $_POST['invoice_city']))."',                                  deliver_country   = '".mysqli_real_escape_string($conn, $_POST['invoice_country'])."',                                  phone             = '".mysqli_real_escape_string($conn, $_POST['phone'])."',                                  active            = '1'                                WHERE email = '".mysqli_real_escape_string($conn, $_POST['email'])."'                                ") or die(mysqli_error($conn));        } // EOF klant updaten.        // Haal de zojuist inserted id op om straks te gebruiken.        $inserted_customer = mysqli_insert_id($conn);        // Customer id nu bepalen, want nieuw of bestaand 2 variabelen waarvan 1 waar.        !empty($customer['idx']) ? $inserted_customer_id = $customer['idx'] : $inserted_customer_id = $inserted_customer;        // Alle bestelde producten van deze klant ophalen	uit CLO_ORDERS_A        $query2 = mysqli_query($conn, "SELECT *                                        FROM clo_orders_a                                        WHERE session_id = '".session_id()."'                                       ") or die(mysqli_error($conn));        // Alle producten vanuit clo_orders_a in clo_orders_b zetten.        while($product = mysqli_fetch_array($query2))        {          //echo 'Ja: '.$product['product_discount'];          mysqli_query ($conn, "INSERT IGNORE INTO clo_orders_b SET                                  session_id            = '".session_id()."',                                  customer_email        = '".strtolower(mysqli_real_escape_string($conn, $_POST['email']))."',                                  item_id               = '".$product['item_id']."',                                  price                 = '".$product['price']."',                                  quantity              = '".$product['quantity']."',                                  millimeter            = '".$product['millimeter']."',                                  price_cuts            = '".$product['price_cuts']."',                                  price_total           = '".$product['price_total']."',                                  product_discount      = '".$product['product_discount']."',                                  product_discount_type = '".$config['promo_discount_type']."',                                  product_option        = '".$product['product_option']."',                                  order_time            = CURTIME()                                  ") or die(mysqli_error($conn));          //echo 'Wachtuh: '.$meter_material;          //exit;          // Nu gaan we de voorraad in deze loop ook aanpassen zodat deze weer klopt.          mysqli_query ($conn, "UPDATE clo_products                                 SET stock = stock - ".$product['quantity']."                                 WHERE idx = '".$product['item_id']."'                                ") or die(mysqli_error($conn));        } // END table A to B.        // Alles nu ook in clo_orders_c zetten.        mysqli_query ($conn, "INSERT IGNORE INTO clo_orders_c SET                      customer_id          = '".$inserted_customer_id."',                      surname              = '".ucfirst(mysqli_real_escape_string($conn, $_POST['surname']))."',                      username             = '".strtolower(mysqli_real_escape_string($conn, $_POST['email']))."',                      session_id           = '".session_id()."',                      order_tax            = '".$tax."',                      order_total          = '".$total."',                      store_discount       = '".$discount."',                      store_discount_type  = '".$config['promo_discount_type']."',                      order_grand_total    = '".$grandtotal."',                      order_payment_name   = '".mysqli_real_escape_string($conn, $_POST['pay_name'])."',                      order_payment_price  = '".mysqli_real_escape_string($conn, $_POST['pay_price'])."',                      order_shipping_name  = '".mysqli_real_escape_string($conn, $_POST['ship_name'])."',                      order_shipping_price = '".mysqli_real_escape_string($conn, $_POST['ship_price'])."',                      order_fee_insurance  = '".mysqli_real_escape_string($conn, $_POST['fee_insurance'])."',                      order_foreign_price  = '".$fee_foreign."',                      order_remarks        = '".$voucher_remarks.ucfirst(mysqli_real_escape_string($conn, $_POST['order_remarks']))."',                      order_status         = 'Ingekomen',                      order_date           = NOW(),                      order_time           = CURTIME()                      ") or die(mysqli_error($conn));        // Haal de zojuist inserted id op om straks te gebruiken bij b.v. iDeal.        $inserted_order_id = mysqli_insert_id($conn);        $final_order_id    = $config['order_id_start'].$config['order_id_initial'].'-'.$inserted_order_id;        // Geef nu ook het door de klant gewenste ordernummer in.        mysqli_query ($conn, "UPDATE clo_orders_c                              SET order_number = '".$final_order_id."'                              WHERE order_idx = '".$inserted_order_id."'                              ") or die(mysqli_error($conn));        // We gaan nu mailen, ongeacht of er met iDeal betaald wordt.        $day       = date('d-m-Y | H:m');        $emailfrom = $config['site_email_info'];        $subject   = "Bestelling: ".$config['shop_name'];        $from      = $config['shop_name'];        $email     = strtolower(mysqli_real_escape_string($conn, $_POST['email']));        empty($_POST['order_remarks']) ? $order_remarks = 'None' :  ucfirst(mysqli_real_escape_string($conn, $order_remarks = $_POST['order_remarks']));        $mailbody = '<!DOCTYPE html>                    <meta http-equiv="content-type" content="utf-8">                                    <html lang="en-NL">                                    <head>                                      <title>Your order at: '.$config['shop_name'].'</title>                                      <style>                        body {                          margin-top:  20px;                          margin-left: 0px;                        }                                        body, div, td {                          color:       #333333;                          font-family: Tahoma, Verdana, Arial;                          font-size :  14px;                        }                                         a {                          color:           #4285F4;                          font-weight:     bolder;                          text-decoration: none;                           letter-spacing:  1px;                        }		                                            a:hover {                          color: #4285F4;                        }                                        hr {                          color:      #999999;                          border:     none;                          border-top: 1px dashed #999999;                          height:     1px;                        }                                        h1, h2, h3 {                          color:         #4285F4;                          font-family:  "Lucida Sans Unicode", "Lucida Grande", sans-serif;                          font-size:     17px;                          font-weight:   bold;                          margin-top:    0px;                          margin-bottom: 0px;                        }                                        b {                          color:       #4285F4;                          font-family: Tahoma, Verdana, Arial;                        }                                        .black {                          color:       #333333;                          font-weight: bold;                          font-family: Tahoma, Verdana, Arial;                        }                      </style>                                    </head>                                    <body bgcolor="#FFFFFF">                                      <table width="800" border="0" cellspacing="0" cellpadding="3">                          <tr>                            <td></td>                            <td colspan="3">                              <hr>                              <h2>'.$LANG["PAGE_SUCCESS_1"].' '.$config["shop_name"].'</h2>                              <hr>                            </td>                          </tr>                                                    <tr>                            <td></td>                            <td>'.$LANG["DATE"].':</td>                            <td></td>                            <td>'.$day.'</td>                          </tr>                                          <tr>                            <td></td>                            <td>'.$LANG["TOPIC"].':</td>                            <td></td>                            <td>'.$subject.'</td>                          </tr>                                          <tr>                            <td></td>                            <td>'.$LANG["ORDER_NUMBER"].':</td>                            <td></td>                            <td><b>'.$final_order_id.'</b></td>                          </tr>                                          <tr>                            <td></td>                            <td>'.$LANG["NAME"].':</td>                            <td></td>                            <td>'.mysqli_real_escape_string($conn, $_POST['saluation']).' '.ucfirst(mysqli_real_escape_string($conn, $_POST['surname'])).'</td>                          </tr>                                          <tr>                            <td></td>                            <td>'.$LANG["STREET"].':</td>                            <td></td>                            <td>'.mysqli_real_escape_string($conn, $_POST['invoice_street']).' '.mysqli_real_escape_string($conn, $_POST['invoice_street_nr']).'</td>                          </tr>                                          <tr>                            <td></td>                            <td>'.$LANG["ZIP"].':</td>                            <td></td>                            <td>'.mysqli_real_escape_string($conn, $_POST['invoice_zip']).'</td>                          </tr>                                          <tr>                            <td></td>                            <td>'.$LANG["CITY"].':</td>                            <td></td>                            <td>'.mysqli_real_escape_string($conn, $_POST['invoice_city']).'</td>                          </tr>                                          <tr>                            <td></td>                            <td>'.$LANG["COUNTRY"].':</td>                            <td></td>                            <td>'.mysqli_real_escape_string($conn, $_POST['invoice_country']).'</td>                          </tr>                                          <tr>                            <td></td>                            <td>'.$LANG["PHONE"].':</td>                            <td></td>                            <td><b>'.mysqli_real_escape_string($conn, $_POST['phone']).'</b></td>                          </tr>                                          <tr>                            <td></td>                            <td>'.$LANG["EMAIL"].':</td>                            <td></td>                            <td><a href="mailto:'.$email.'">'.$email.' &raquo;</a></td>                          </tr>                                          <tr>                            <td></td>                            <td>'.$LANG["HOW_DID_YOU"].':</td>                            <td></td>                            <td><b>'.mysqli_real_escape_string($conn, $_POST['found']).'</b></td>                          </tr>					                                          <tr>                            <td></td>                            <td colspan="3" align="center">                              <hr>                            </td>                          </tr>                                          <tr>                            <td></td>                            <td valign="top"><b>'.$LANG["REMARKS"].':</b></td>                            <td></td>                            <td valign="top">'.$voucher_remarks.$order_remarks.'</td>                          </tr>                                          <tr>                            <td></td>                            <td colspan="3" align="center">                              <hr>                            </td>                          </tr>                                          <tr>                            <td></td>                            <td><b>'.$LANG["DELIVERY"].':</b></td>                            <td></td>                            <td>'.$_POST['ship_name'].'</td>                          </tr>                                          <tr>                            <td></td>                            <td><b>'.$LANG["PAYMENT"].':</b></td>                            <td></td>                            <td>'.$_POST['pay_name'].'</td>                          </tr>                                          <tr>                            <td></td>                            <td><b>'.$LANG["PRICE"].':</b></td>                            <td></td>                            <td>'.$tax_text.'</td>                          </tr>                                                    <tr>                            <td></td>                            <td colspan="3" align="center">                              <hr>                            </td>                          </tr>                                          <tr>                            <td></td>                            <td colspan="3">                              <h2>'.$LANG["YOUR_ORDER"].':</h2>                            </td>                          </tr>                                          <tr>                            <td></td>                            <td colspan="3" align="center">                              <hr>                            </td>                          </tr>                          ';                      // Alle bestelde producten van deze klant ophalen	uit clo_orders_a want "burned" in vorige query                      $query4 = mysqli_query($conn, "SELECT *                                                      FROM clo_orders_a                                                      WHERE session_id = '".session_id()."'                                                     ");                      while($mailproduct = mysqli_fetch_array($query4))                      {                        $query5 = mysqli_query($conn, "SELECT *                                                        FROM clo_products                                                        WHERE idx = '".$mailproduct['item_id']."'                                                       ");                        $row = mysqli_fetch_array($query5);                        // Ordertotaal ophalen om mee te rekenen.                        $query6 = mysqli_query($conn, "SELECT SUM(price_total)                                                        AS everything                                                        FROM clo_orders_a                                                        WHERE session_id = '".session_id()."'                                                       ");                        $everything = mysqli_fetch_assoc($query6);                        if($mailproduct['millimeter'] == 0) // GEEN metermateriaal.                        {                          $mailbody .= '                                            <tr>                              <td></td>                              <td colspan="3">                                                              <table width="100%" border="0" cellspacing="0" cellpadding="1">                                  <tr>                                    <td width="100"><b>'.$LANG["ARTICLE_NR"].':</b></td>                                     <td width="10">&nbsp;</td>                                    <td>'.$row['product_number'].'</td>                                  </tr>                                                <tr>                                    <td><b>'.$LANG["TITLE"].':</b></td>                                     <td width="20">&nbsp;</td>                                    <td>'.word_count($row['product_title_'.$_SESSION['language'].''],10)."".'.</td>                                  </tr>										                                 ';                          // Optie waardes nu laten zien.                          if(!empty($mailproduct['product_option']))                          {                            $string = explode(';',$mailproduct['product_option']);                            foreach ($string as $key => $value)                            {                              $real_value = explode('#',$value);                              // Lege waarde vanwege explode er uit filteren, kan dat ook anders?                              if(!empty($real_value[0]))                              {                                $mailbody .= '<tr>                                                <td><b>'.$LANG["OPTIONS"].':</b></td>                                                 <td width="20">&nbsp;</td>                                                <td>'.$real_value[0].' '.$real_value[1].' &euro; '.$real_value[2].'</td>                                              </tr>                                              ';                              }                            }                          }                          $mailbody .= '<tr>                                          <td><b>'.$LANG["PIECES"].':</b></td>                                           <td width="20">&nbsp;</td>                                          <td>'.$mailproduct['quantity'].'</td>                                        </tr>                                                                <tr>                                          <td><b>'.$LANG["PRICE"].':</b></td>                                           <td width="20">&nbsp;</td>                                          <td><b class="black">&euro; '.number_format($mailproduct['price'], 2, ',', '.').'</b> '.$LANG["PER_UNIT"].'.</td>                                        </tr>								                                        ';                          // Eventueel aantal stuks van 1 unit tonen wanneer dit ingesteld is.                          // Dan eerst ook weer de product_unit van het artikel opvragen want nog nergens beschikbaar.                          $query7 = mysqli_query($conn, "SELECT product_unit                                                          FROM clo_products                                                          WHERE idx = '".$mailproduct['item_id']."'                                                         ");                          $item_id = mysqli_fetch_array($query7);                          $query8 = mysqli_query($conn, "SELECT *                                                          FROM clo_units                                                          WHERE idx = '". $item_id['product_unit']."'                                                         ");                          $unit = mysqli_fetch_array($query8);                          if($unit['unit_name_'.$_SESSION['language'].''] != '')                          {                            $mailbody .= '<tr>                                            <td><b>'.$LANG["PACKED"].':</b></td>                                             <td width="20">&nbsp;</td>                                            <td>'.$unit['unit_name_'.$_SESSION['language'].''].' van '.$unit['unit_value'].' '.$LANG["PIECES"].'.</td>                                          </tr>                                          ';                          }                          $mailbody .= '<tr>                                          <td><b>'.$LANG["SUBTOTAL"].':</b></td>                                           <td width="20">&nbsp;</td>                                          <td><b class="black">&euro; '.number_format($mailproduct['price_total'], 2, ',', '.').'</b></td>                                        </tr>                                                            <tr>                                          <td colspan="3"><br><hr></td>                                         </tr>								                                      </table>                                                        </td>                                </tr>                                ';                        }                        else if ($mailproduct['millimeter'] != 0) // WEL metermateriaal.                        {                          $mailbody .= '<tr>                                          <td></td>                                          <td colspan="3">                                                                      <table width="100%" border="0" cellspacing="0" cellpadding="1">                                              <tr>                                                <td><b>'.$LANG["ARTICLE_NR"].':</b></td>                                                 <td width="20">&nbsp;</td>                                                <td>'.word_count($row['product_title'],10)."".'.</td>                                              </tr>                                                                        <tr>                                                <td><b>'.$LANG["PIECES"].':</b></td>                                                 <td width="20">&nbsp;</td>                                                <td>'.$mailproduct['quantity'].' '.$LANG["PIECE"].':</span> '.$mailproduct['millimeter'].' mm. '.$LANG["PER_LENGTH"].'.</td>                                              </tr>	                                                                        <tr>                                                <td><b>'.$LANG["PRICE"].':</b></td>                                                 <td width="20">&nbsp;</td>                                                <td>&euro; '.number_format($mailproduct['price'], 2, ',', '.').' '.$LANG["PER_METER"].'.</td>                                              </tr>	                                                                        <tr>                                                <td><b>'.$LANG["TOTAL"].':</b></td>                                                 <td width="20">&nbsp;</td>                                                <td>&euro; '.number_format($mailproduct['price_total'], 2, ',', '.').' | incl. &euro; '.$mailproduct['price_cuts'].' '.$LANG["CUTTING_COSTS"].'.</td>                                              </tr>																														                                                                        <tr>                                                <td colspan="3"><br><hr></td>                                               </tr>								                                                                      </table>								                                                                    </td                                      </tr>                                      ';                        }                      }                      $mailbody .= '<tr>                                      <td></td>                                      <td colspan="3">                                        <h2>'.$LANG["COSTS"].':</h2>                                      </td>                                    </tr>                                                              <tr>                                      <td></td>                                      <td colspan="3" align="center">                                        <hr>                                      </td>                                    </tr>                                                              <tr>                                      <td></td>                                        <td colspan="3">                                                                    <table width="*" border="0" cellspacing="1" cellpadding="1">                                            <tr>                                              <td width="150"><b>'.$LANG["SUBTOTAL"].':</b></td>                                              <td align="center" width="20" ><b>&euro;</b></td>                                              <td align="right"><b>'.number_format($everything['everything'], 2, ',', '.').'</b></td>                                            </tr>                                                                    <tr>                                              <td>'.$LANG["SHIPPING_COSTS"].':</td>                                              <td align="center">&euro;</td>                                              <td align="right">'.number_format($_POST['ship_price'], 2, ',', '.').'</td>                                            </tr>                                                                    <tr>                                              <td>'.$LANG["PAYMENT_COSTS"].':</td>                                              <td align="center">&euro;</td>                                              <td align="right">'.number_format($_POST['pay_price'], 2, ',', '.').'</td>                                            </tr>                                            ';                      /* ===================================================== */                      if ($insurance != '0.00')                      {                        $mailbody .= '<tr>                                        <td>'.$LANG["INSURANCE"].':</td>                                        <td align="center">&euro;</td>                                        <td align="right">'.number_format($insurance, 2, ",", ".").'</td>                                      </tr>';                      }                      /* ===================================================== */                      if ($fee_foreign != '0.00')                      {                        $mailbody .= '<tr>                                        <td>'.$LANG["FOREIGN_DELIVERY"].':</td>                                        <td align="center">&euro;</td>                                        <td align="right">'.number_format($fee_foreign, 2, ",", ".").'</td>                                      </tr>';                      }                      /* ===================================================== */                      if ($discount != '0.00')                      {                        $mailbody .= '<tr>                                        <td>'.$LANG["OUR_DISCOUNT"].':</td>                                        <td align="center">&euro;</td>                                        <td align="right">- '.number_format($discount, 2, ",", ".").'</td>                                      </tr>';                      }                      /* ===================================================== */                      if ($voucher_yes == 1)                      {                        $mailbody .= '<tr>                                        <td>'.$LANG["VOUCHER_CODE"].':</td>                                        <td align="center">&euro;</td>                                        <td align="right"><b>- '.$voucher_euro.'<b></td>                                      </tr>';                      }                      /* ===================================================== */                      $mailbody .= '<tr>                                      <td colspan="3" align="center">                                        <hr>                                      </td>                                    </tr>                                                      <tr>                                        <td><b>'.$LANG["SUBTOTAL"].':</b></td>                                        <td align="center"><b>&euro;</b></td>                                        <td align="right"><b>'.number_format($total, 2, ',', '.').'</b></td>                                    </tr>                                                      <tr>                                        <td>'.$LANG["VAT"].' '.$config['tax_percent'].'%</td>                                        <td align="center">&euro;</td>                                        <td align="right">'.number_format($tax, 2, ',', '.').'</td>                                    </tr>                                                      <tr>                                        <td colspan="3" align="center">                                          <hr>                                        </td>                                    </tr>                                                      <tr>                                        <td><span class="black">'.$LANG["TOTAL"].':</span></td>                                        <td align="center"><span class="black">&euro;</span></td>                                        <td align="right"><span class="black">'.number_format($grandtotal, 2, ',', '.').'</span></td>                                    </tr>                                                    </table>                                                  </td>                            </tr>                                              <tr>                                <td></td>                                <td colspan="3" align="center">                                  <hr>                                  <br>                                  '.$config['shop_name'].' - '.$config['shop_address'].' - '.$config['shop_zip'].' - '.$config['shop_city'].' - '.$config['shop_country'].' - T: '.$config['shop_phone'].'<br>                                  E: <a href="mailto:'.$config['site_email_info'].'">'.$config['site_email_info'].'</a> - W: <a href="'.$config['path_url'].'">'.$config['path_url'].'</a><br>                                  '.$config['shop_bank_name'].' - '.$config['shop_bank_bic'].' - '.$config['shop_bank_iban'].'<br>                                  <br>                                  <hr>                                </td>                            </tr>                                          </table>                                    </body>                                    </html>';        // Sla de complete email nu ook op in de database bij de betreffende order.        mysqli_query ($conn, "UPDATE clo_orders_c                              SET order_mailbody = '".mysqli_real_escape_string($conn, $mailbody)."'                              WHERE order_idx = '".$inserted_order_id."'                              ") ;        // Zet de eventuele voucher code nu op inactief (0).        if($voucher_yes == 1)        {          mysqli_query ($conn, "UPDATE clo_vouchers                                 SET active = '0'                                 WHERE coupon_code = '".$voucher['coupon_code']."'                                 AND coupon_email = '".$email."'                                ");        }        // Mail eerst testen bedragen etc. voor verzending, echo naar scherm.        if($super['test_mail'])        {          echo $mailbody;          exit;        }        // Stuur een e-mail naar de gebruiker en naar de shop eigenaar.        mail($emailfrom, $subject, $mailbody,"From: $emailfrom \nReply-To: $emailfrom\nX-Mailer: $from\nMIME-Version: 1.0\nContent-Type: text/html; charset=utf-8");        mail($email, $subject, $mailbody,"From: $emailfrom \nReply-To: $emailfrom\nX-Mailer: $from\nMIME-Version: 1.0\nContent-Type: text/html; charset=utf-8");/* ========================================================== START IDEAL ============================================================ */        // Als de betaalmethode iDeal is dan gaan we daar nu naar toe.          if($msp == 'ideal') // BOF iDeal        {          require_once('includes/ideal_config.php');          require_once('includes/ideal_functions.php');          // De datum:          $de_datum = date('Y-m-d');          // Define the variables needed for iDeal          $sSignature   = '';          $sSql         = '';          $sRequest     = '';          $sReply       = '';          $sError       = '';          $aRow         = [];          $aMatches     = [];          $aMerchant    = [];          $aTransaction = [];          $aCustomer    = [];          $aPostFields  = [];          $rResult      = NULL;          // First we check if the cURL function exists on this servers configuration.          if(function_exists('curl_init') === TRUE)          {            // Define variables.            $bedrag      = $grandtotal;            $sName       = "".mysqli_real_escape_string($conn, $_POST['saluation'])." ".mysqli_real_escape_string($conn, $_POST['surname'])."";            $sCity       = mysqli_real_escape_string($conn, $_POST['invoice_city']);            $sEmail      = $email;            $sAmount     = number_format($bedrag, 2, '.', '');            $sPhone      = mysqli_real_escape_string($conn, $_POST['phone']);            $sBetaalcode = "Betaal id: ".$final_order_id."";            $sRemarks    = mysqli_real_escape_string($conn, $_POST['order_remarks']);            // Collect all transaction details.            $aTransaction['id']          = mt_rand(100000, 999999);            $aTransaction['currency']    = 'EUR';            $aTransaction['amount']      = number_format($sAmount, 2, '', '');            $aTransaction['description'] = 'Payment '.SHOPNAME.'';            $aTransaction['var1']        = $sName;            $aTransaction['var2']        = '';            $aTransaction['var3']        = '';            $aTransaction['items']       = '';            $aTransaction['manual']      = '';            // Collect all customer details.            $aCustomer['locale']      = 'NL';            $aCustomer['ipaddress']   = $_SERVER['REMOTE_ADDR'];            $aCustomer['forwardedip'] = $_SERVER['HTTP_X_FORWARDED_FOR'];            $aCustomer['name']        = substr($sName, strpos($sName, ' '));            $aCustomer['city']        = $sCity;            $aCustomer['phone']       = $sPhone;            $aCustomer['email']       = $sEmail;            $aCustomer['betaalcode']  = $sBetaalcode;            $aCustomer['remarks']     = $sRemarks;            $aCustomer['payment_id']  = $sPayment_id;            // Collect all merchant details.            $aMerchant['account']          = MERCHANT_ACCOUNT;            $aMerchant['site_id']          = MERCHANT_SITE_ID;            $aMerchant['site_secure_code'] = MERCHANT_SITE_SECURE_CODE;            $aMerchant['notification_url'] = MERCHANT_NOTIFICATION_URL;            // Calculate the signature.            $sSignature = md5($aTransaction['amount'].$aTransaction['currency'].$aMerchant['account'].$aMerchant['site_id'].$aTransaction['id']);            // Generate the XML request.            $sRequest  = '<?xml version="1.0" encoding="UTF-8"?>'.PHP_EOL;            $sRequest .= '<redirecttransaction ua="example-1.1">'.PHP_EOL;            $sRequest .= arrayToXml($aMerchant, 'merchant');            $sRequest .= arrayToXml($aCustomer, 'customer');            $sRequest .= arrayToXml($aTransaction, 'transaction');            $sRequest .= '<signature>'. $sSignature .'</signature>'.PHP_EOL;            $sRequest .= '</redirecttransaction>'.PHP_EOL;            // Post the request to MultiSafepay.            if($sReply = postXml(API_URL, $sRequest, $sError))            {              // Check transaction status from reply              preg_match('/\<redirecttransaction result="(.*)"\>/U', $sReply, $aMatches);              if(count($aMatches) > 0 && $aMatches[1] == 'ok')              {                $aMatches = [];                // Get URL to redirect to                preg_match('/\<payment_url\>(.*)\<\/payment_url\>/U', $sReply, $aMatches);                if(count($aMatches) > 0)                {                  // Redirect to the given URL                  header('Location: '.unescapeXml($aMatches[1]).'');                    exit;                  }                else                {                  $sError = 'Unable to redirect user.';                }              }              // Get the error message.              $aMatches = [];                preg_match('/\<error\>.*\<description\>(.*)\<\/description\>.*\<\/error\>/U', $sReply, $aMatches);              if($aMatches > 0)              {                $sError = unescapeXml($aMatches[1]);              }              echo $sError;            }          }          else          {            // cURL not available, present error message.            echo "cURL is not available on this webserver, contact your ISP.";          }          // Orders en sessies nu verwijderen uit clo_orders_a in het geval van een MSP betaling.          mysqli_query ($conn, "DELETE FROM clo_orders_a                                 WHERE session_id = '".session_id()."'                                ");          session_unset();          session_destroy();          session_write_close();          setcookie(session_name(),'',0,'/');          session_regenerate_id(true);            // EOF MSP/* ========================================================== START MOLLIE ============================================================ */        }        elseif (strpos($msp, 'mollie_', 0) === 0)        {          // First we check to see if the requested method is enabled in the database          $query  = mysqli_query($conn, "SELECT active                                          FROM clo_payments                                          WHERE pay_config = '" . mysqli_real_escape_string($conn, $msp) . "'                                          AND active = 1                                          LIMIT 1                                         ");          if (mysqli_num_rows($query) !== 1)          {            echo 'The selected payment method is invalid.';              exit;          }          try          {            require_once __DIR__ . '/includes/Mollie/API/Autoloader.php';            $mollie = new Mollie_API_Client();            $mollie->setApiKey($config['mollie_api_key']);            $payment = $mollie->payments->create([              'amount'      => number_format($grandtotal, 2, '.', ''),              'method'      => substr($msp, 7),              'locale'	    => $_SESSION['language'],              'description' => 'Betaling ' . htmlspecialchars($config['shop_name']),              'metadata' => json_encode([                'order_id'    => $final_order_id,              ]),                'redirectUrl' => $config['msp_base_url'] . '/page-succes.php?order='.$final_order_id,            ]);            $query = "UPDATE clo_orders_c                       SET mollie_order_id = '".mysqli_real_escape_string($conn, $payment->id)."'                       WHERE order_number = '".mysqli_real_escape_string($conn, $final_order_id)."'                       LIMIT 1                      ";              $result = mysqli_query($conn, $query) or die (mysqli_error($conn));            header('Location: ' . $payment->getPaymentUrl());              exit;            }          catch (Mollie_API_Exception $e)          {            echo 'API call failed: ' . htmlspecialchars($e->getMessage());            echo ' on field ' . htmlspecialchars($e->getField());              exit;          }        }        // Orders en sessies nu verwijderen uit clo_orders_a in het geval van een normale bestelling.        mysqli_query ($conn, "DELETE FROM clo_orders_a WHERE session_id = '".session_id()."'") or die (mysqli_error($conn));        session_unset();        session_destroy();        session_write_close();        setcookie(session_name(),'',0,'/');        echo '<script language="JavaScript">location.href="page-succes.php?language='.$language.'"</script>';        break;    }  }